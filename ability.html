<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        <script src="./utils.js?update=20190405_1" ></script>
        <title>ロマサガRS アビリティツリー@nao_romasaga</title>
        <!-- http://ifs.nog.cc/hkaityo.hp.infoseek.co.jp/dq/rs2-01.html -->
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
        <link href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./style.css?update=20190405_1">
        <style>
            .node {
                cursor: pointer;
            }

            .node circle {
                fill: #fff;
                stroke: steelblue;
                stroke-width: 1.5px;
            }

            .link {
                fill: none;
                stroke: #555;
                stroke-opacity: 0.6;
                stroke-width: 1.5px;
            }
        </style>
    </head>
    <body>

        <div class ="haikei"><div class="container">
                <div class="text-center">
                    <a href="https://www.jp.square-enix.com/saga_reuniverse/" target="new"><img src="https://www.jp.square-enix.com/saga_reuniverse/assets/img/cmn_logo01_sp.png" class="col-sm-12 col-md-8 col-lg-6"></a>
                </div>
                <h2 class="text-center opacity">アビリティツリー(仮)</h2>
                <div class="text-center opacity">現在PCのみ対応中
                </div>
                <p class="text-right opacity"><small>バグ発見、ご要望は <a href="https://twitter.com/nao_romasaga_rs" target="new">nao_romasaga_rs</a>まで</small>
                </p>

                <label for="wepon" class="badge badge-pill badge-light">ラベルor○クリックで展開します。アビリティ名をクリックでスタイル表示します。</label><br>
                <svg width="100%" height="500" class="bg-white"></svg>
                <table class="table table-hover table-bordered table-sm" id="skill_holder_table">
                    <thead>
                        <tr class="text-center opacity table-success xs-hide">
                            <th style="width:50px">Rare</th>
                            <th style="width:160px">Name/Style</th>
                            <th>Skill</th>
                            <th>Ability</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white"></tbody>
                </table>
                <br>
                <div style="display: none" id="imgTank">
                    <img src="" id="icon_A">
                    <img src="" id="icon_S">
                    <img src="" id="icon_SS">
                </div>

            </div></div> <!-- main -->

        <!--script src="https://www.gstatic.com/firebasejs/5.9.1/firebase.js"></script-->
        <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-database.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-storage.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-auth.js"></script>
        <script src="./Firebase.js?v=20190407_2"></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>

        <script type="text/javascript">
setImgTag("icon/icon_a.png", "icon_A");
setImgTag("icon/icon_s.png", "icon_S");
setImgTag("icon/icon_ss.png", "icon_SS");            
            var ABILITY_MASTER, STYLE_MASTER;
            var ABILITY_MASTER_NAME = {};
            var data = {"name": "Abiliry", "children": []};
            var tree;
            $(function () {
                firebase.database().ref('Ability').once("value").then(function (snapshot) {
                    console.log(snapshot.val());
                    ABILITY_MASTER = snapshot.val();
                    let tmpList = {};
                    for (let key in ABILITY_MASTER) {
                        let row = ABILITY_MASTER[key];
                        let main = row['main'];
                        let sub = row['sub'];
                        let when = row['when'];
                        let time = row['time'];
                        let size = row['size'];
                        let name = row['Name'] + "(" + when;
                        if (time !== "") {
                            name += "/" + time;
                        }
                        name += ")";

                        ABILITY_MASTER_NAME[name] = row;
                        if (tmpList[main] === undefined) {
                            tmpList[main] = {};
                        }
                        if (tmpList[main][sub] === undefined) {
                            tmpList[main][sub] = {};
                        }
                        if (tmpList[main][sub][size] === undefined) {
                            tmpList[main][sub][size] = [];
                        }
                        /*
                         if (tmpList[main][sub][size][when] === undefined) {
                         tmpList[main][sub][size][when] = {};
                         }
                         if (tmpList[main][sub][size][when][time] === undefined) {
                         tmpList[main][sub][size][when][time] = [];
                         }
                         */
                        tmpList[main][sub][size].push(name);
                    }
                    for (let main in tmpList) {
                        let mainList = {"name": main, "children": []};
                        for (let sub in tmpList[main]) {
                            var subList = {"name": sub, "children": []};
                            for (let size in tmpList[main][sub]) {
                                var sizeList = {"name": size, "children": []};
                                for (let name of tmpList[main][sub][size]) {
                                    sizeList['children'].push({"name": name});
                                    /*
                                     var whenList = {"name": when, "children": []};
                                     for (let time in tmpList[main][sub][size][when]) {
                                     let map = {"name": tmpList[main][sub][size][when][time]};
                                     whenList['children'].push(map);
                                     }
                                     sizeList['children'].push(whenList);
                                     */
                                }
                                subList['children'].push(sizeList);
                            }
                            mainList['children'].push(subList);
                        }
                        data['children'].push(mainList);
                    }

                    // 2. 描画用データの準備
                    var width = document.querySelector("svg").clientWidth;
                    var height = document.querySelector("svg").clientHeight;
                    // 3. 描画用データの変換(ふわっと出る起点)
                    root = d3.hierarchy(data);
                    root.x0 = height / 2;
                    root.y0 = 0;

                    tree = d3.tree().size([height, width - 160]);

                    // 4. svgデータの描画用データの変換
                    g = d3.select("svg").append("g").attr("transform", "translate(80,0)");
                    update(root);

                    // 初期表示の場合はたたむ
                    $(".node").each(function (i, d) {
                        // この無理矢理感たるや
                        if (i > 0 && i <= 16) {
                            toggle(d["__data__"]);
                            update(d["__data__"]);
                        }
                    });
                });
            });
            firebase.database().ref('Style').once("value").then(function (snapshot) {
                //console.log(snapshot.val());
                STYLE_MASTER = snapshot.val();
            });

            function displayAbilityHolder(holders) {
                $("table#skill_holder_table tbody *").remove();

                for (key in holders['Holders']) {
                    let styleId = holders['Holders'][key];
                    let imgId = "cutin" + styleId;
                    let imgId2 = "tmp" + styleId;
                    let imgSrc = "";
                    // 画像が存在する場合は再取得しない
                    if ($('#' + imgId).length == 0) {
                        $("#imgTank").append("<img src=\"\" id=\"" + imgId + "\">");
                        setImgTag("style_cutin/" + styleId.substr(2) + ".png", imgId);
                        setImgTag("style_cutin/" + styleId.substr(2) + ".png", imgId2);
                    } else {
                        imgSrc = $("#" + imgId).attr('src');
                    }
                    let styleInfo = STYLE_MASTER[styleId];

                    let rarityIcon = $("#icon_" + styleInfo['Rarity']).attr('src');

                    let color = "background-color: rgb(246,236,100);}";
                    if (styleInfo['Rarity'] === "A") {
                        color = "background-color: rgb(247,170,150);}";
                    } else if (styleInfo['Rarity'] === "S") {
                        color = "background-color: rgb(200,224,234);}";
                    }

                    let col = "";
                    let styleName = styleInfo['AnotherName'];
                    let Name = styleInfo['Name'];
                    let height = 50;
                    col += "<td><img src=\"" + rarityIcon + "\" height=" + height + "></td>";
                    col += "<td class='text-center'>";
                    col += "<img src=\"" + imgSrc + "\" height=" + height + " id=\"" + imgId2 + "\"><br>";
                    col += "<small style='line-height:0px !important;'>" + Name;
                    col += "<p class='xs-hide'>" + styleName + "</p>";
                    col += "</small></td>";
                    col += "<td class='xs-hide'>" + styleInfo['Skill'].join("<br>") + "</td>";
                    let ab = [];
                    for (let lv in styleInfo['StyleAbilityIds']) {
                        let abId = styleInfo['StyleAbilityIds'][lv];
                        let abInfo = ABILITY_MASTER[abId];
                        ab.push(lv + ":" + abInfo["Name"] + " <small>" + abInfo["FlavorText"]+"</small>");
                    }
                    col += "<td>" + ab.join("<br>") + "</td>";
                    $("table#skill_holder_table tbody").append("<tr style='" + color + "'>" + col + "</tr>\n");
                }
            };


            // 5. クリック時の呼び出し関数
            function toggle(d) {
                // childrenが定義されているかどうかで末端ノードを判断する
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                } else {
                    d.children = d._children;
                    d._children = null;
                }
                if (d.data["children"] === undefined) {
                    let ab = ABILITY_MASTER_NAME[d.data["name"]];
                    console.log(ab);
                    displayAbilityHolder(ab);
                }
            }

            // ６.svg要素の更新関数
            var i = 0;
            function update(source) {

                // tree レイアウト位置を計算
                tree(root);

                // 子、孫方向の位置設定
                root.each(function (d) {
                    d.y = d.depth * 120;
                });

                // ノードデータをsvg要素に設定
                var node = g.selectAll('.node')
                        .data(root.descendants(), function (d) {
                            return d.id || (d.id = ++i);
                        });

                // ノード enter領域の設定
                var nodeEnter = node
                        .enter()
                        .append("g")
                        .attr("class", "node")
                        .attr("transform", function (d) {
                            return "translate(" + source.y0 + "," + source.x0 + ")";
                        })
                        .on("click", function (d) {
                            toggle(d);
                            update(d);
                        });

                nodeEnter.append("circle")
                        .attr("r", 5)
                        .style("fill", function (d) {
                            return d._children ? "lightsteelblue" : "#fff";
                        });

                nodeEnter.append("text")
                        .attr("x", function (d) {
                            // ラベル表示位置
                            return d.children || d._children ? -13 : 13;
                        })
                        .attr("dy", "3")
                        .attr("font-size", "90%")
                        .attr("text-anchor", function (d) {
                            return d.children || d._children ? "end" : "start";
                        })
                        .text(function (d) {
                            return d.data.name;
                        })
                        .style("fill-opacity", 1e-6);

                // ノード enter+update領域の設定
                var nodeUpdate = nodeEnter.merge(node);
                var duration = 500;

                nodeUpdate.transition()
                        .duration(duration)
                        .attr("transform", function (d) {
                            return "translate(" + d.y + "," + d.x + ")";
                        });

                nodeUpdate.select("circle")
                        .attr("r", 8)
                        .style("fill", function (d) {
                            return d._children ? "lightsteelblue" : "#fff";
                        });

                nodeUpdate.select("text")
                        .style("fill-opacity", 1);

                // ノード exit領域の設定
                var nodeExit = node
                        .exit()
                        .transition()
                        .duration(duration)
                        .attr("transform", function (d) {
                            return "translate(" + source.y + "," + source.x + ")";
                        })
                        .remove();

                nodeExit.select("circle").attr("r", 1e-6);

                nodeExit.select("text")
                        .style("fill-opacity", 1e-6);

                // リンクデータをsvg要素に設定
                var link = g.selectAll(".link")
                        .data(root.links(), function (d) {
                            return d.target.id;
                        });

                // リンク enter領域のsvg要素定義
                var linkEnter = link.enter().insert('path', "g")
                        .attr("class", "link")
                        .attr("d", d3.linkHorizontal()
                                .x(function (d) {
                                    return source.y0;
                                })
                                .y(function (d) {
                                    return source.x0;
                                }));

                // リンク enter+update領域の設定
                var linkUpdate = linkEnter.merge(link);
                linkUpdate
                        .transition()
                        .duration(duration)
                        .attr("d", d3.linkHorizontal()
                                .x(function (d) {
                                    return d.y;
                                })
                                .y(function (d) {
                                    return d.x;
                                }));

                // リンク exit領域の設定
                link.exit().transition()
                        .duration(duration)
                        .attr("d", d3.linkHorizontal()
                                .x(function (d) {
                                    return source.y;
                                })
                                .y(function (d) {
                                    return source.x;
                                })
                                )
                        .remove();

                // 次の動作のために現在位置を記憶
                node.each(function (d) {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });
            }
        </script>
    </body>
</html>
