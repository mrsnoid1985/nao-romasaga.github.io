<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

        <title>ロマサガRS 計算機@nao_romasaga</title>

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
        <link href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c" rel="stylesheet">
        <style type="text/css"><!--
            .haikei { background:url(https://www.jp.square-enix.com/saga_reuniverse/assets/img/index_kv01_sp.jpg) center no-repeat; background-size: cover;}
            .side-padding-zero {
                padding-left: 0px !important;
                padding-right: 0px !important;
            }
            .opacity {
                background-color: rgba(245, 245, 245, 1);
                opacity: 0.8;
            }
            body {
                color: #333;
                font-family: 'M PLUS Rounded 1c', sans-serif;
                line-height: 1.8;
            }            
            .kadomaru {
                border-radius: 8px;
                padding-left: 3px;
            }
            --></style>
    </head>
    <body>
        <div class ="haikei">
            <div class="text-center">
                <a href="https://www.jp.square-enix.com/saga_reuniverse/" target="_new"><img src="https://www.jp.square-enix.com/saga_reuniverse/assets/img/cmn_logo01_sp.png" class="col-sm-12 col-md-8 col-lg-6"></a>
            </div>

            <h1 class="text-center opacity">ロマサガRS 計算機</h1>
            <br>
            <div class="text-center">
            </div>
            <p class="text-right opacity"><small>バグ発見、ご要望は <a href="https://twitter.com/nao_romasaga_rs" target="_new">nao_romasaga_rs</a>まで</small>
            </p>
            <div class="text-center">
                <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="true">Tweet</a>
                <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            </div>

            <br>

            <ul class="nav nav-tabs ">
                <li class="nav-item col-6 text-center side-padding-zero">
                    <a class="nav-link active bg-white" data-toggle="tab" href="#home" id="damageTab" class="">
                        <img src="https://www.silhouette-illust.com/wp-content/uploads/2017/05/buki_saber_30117-300x300.jpg" width="16" height="16">
                        ダメージ計算器
                        <img src="https://www.silhouette-illust.com/wp-content/uploads/2017/05/buki_tsurugi_30115-300x300.jpg" width="16" height="16">
                    </a>
                </li>
                <li class="nav-item col-6 text-center side-padding-zero">
                    <a class="nav-link bg-white" data-toggle="tab" href="#profile" id="vitTab" class="bg-white">
                        <img src="http://icooon-mono.com/i/icon_11077/icon_110770.svg" width="16" height="16">
                        敵体力測定器
                        <img src="http://icooon-mono.com/i/icon_13327/icon_133270.svg" width="16" height="16">
                    </a>
                </li>
            </ul>
            <div id="myTabContent" class="tab-content opacity kadomaru">
                <div class="tab-pane fade show active" id="home">
                    <p>ダメージ計算機はA武器とB武器のどちらの方が強いか。AスタイルとBスタイルのどちらの方が強いかなどの比較検討にご利用ください</p>
                </div>
                <div class="tab-pane fade" id="profile">
                    <p>モンスター体力測定器は武器威力・腕力・マスターレベル・ダメージから敵モンスターの体力を測定します。<br>何かの検証に役立ててください</p>
                </div>
            </div>

            <div class="row">
                <div class="form-group col-xs-12 col-md-6 col-lg-4">
                    <label for="type" class="badge badge-pill badge-light">武器種類
                        <img src="https://www.silhouette-illust.com/wp-content/uploads/2017/05/buki_tsurugi_30115-300x300.jpg" width="16" height="16">
                        <img src="https://icon-rainbow.com/i/icon_03146/icon_031460.svg" width="16" height="16">
                        <img src="https://www.silhouette-ac.com/sozai/m/130/72/130729m.jpg" width="16" height="16">
                        <img src="https://data.ac-illust.com/data/thumbnails/c3/c32a863d8869dac257763aee737baaed_t.jpeg" width="16" height="16">
                        <img src="https://www.silhouette-illust.com/wp-content/uploads/2016/12/20579-300x300.jpg" width="16" height="16">
                        <img src="https://www.silhouette-illust.com/wp-content/uploads/2017/09/witch_tsue_39880-300x300.jpg" width="16" height="16">
                        <img src="https://www.silhouette-illust.com/wp-content/uploads/2017/04/kobushi_nigiru_28889-300x300.jpg" width="16" height="16">
                        <img src="" width="16" height="16">

                    </label>
                    <select class="form-control" id="type" name="type">
                        <option value="1">剣・大剣・斧・槍・棍棒・杖</opition>
                        <option value="2">小剣・弓</opition>
                        <option value="3">体術</opition>
                    </select>
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-4">
                    <label for="wepon" class="badge badge-pill badge-light">武器威力
                        <img src="https://www.silhouette-illust.com/wp-content/uploads/2017/05/buki_tsurugi_30115-300x300.jpg" width="16" height="16">
                    </label>
                    <input type="number" class="form-control damage" id="wepon">
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-4">
                    <label for="str" id="param_label" class="badge badge-pill badge-light">
                        腕力
                        <img src="https://www.silhouette-illust.com/wp-content/uploads/2017/04/training_chikara-kobu_28491-300x300.jpg" width="16" height="16">
                    </label>
                    <input type="number" class="form-control damage" id="str">
                    <small class="form-text text-muted   opacity kadomaru">スタイル、装備込みの値を入力してください。陣形ボーナスは後日対応</small>
                </div>    
                <div class="form-group col-xs-12 col-md-6 col-lg-4"  id="taijyutsu">
                    <label for="agi" id="param_label" class="badge badge-pill badge-light">素早さ</label>
                    <input type="number" class="form-control damage" id="agi">
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-4">
                    <label for="master" class="badge badge-pill badge-light">
                        マスターレベル
                        <img src="https://www.silhouette-illust.com/wp-content/uploads/2016/09/8957-300x300.jpg" width="16" height="16">

                    </label>
                    <input type="number" class="form-control damage" id="master">
                    <small class="form-text text-muted  opacity kadomaru">対象武器種類のマスターレベルを入力して下さい</small>
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-4">
                    <label for="ability" class="badge badge-pill badge-light">アビリティ
                        <img src="https://www.silhouette-illust.com/wp-content/uploads/2017/03/idea_hirameki_28161-300x300.jpg" width="16" height="16">

                    </label>
                    <input type="number" class="form-control damage" id="ability">
                    <small class="form-text text-muted  opacity kadomaru">テンションアップや勇健強撃などによる補正の%を入力して下さい<br>
                        勇健強撃 I:5% II:10% III:15%、テンションアップ I:2% II:5% III:10% IV:15%</small>
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-4">
                    <label for="resist" class="badge badge-pill badge-light">
                        敵耐性
                        <img src="https://www.silhouette-illust.com/wp-content/uploads/2016/12/shield_21084-300x300.jpg" width="16" height="16">
                    </label>
                    <input type="number" class="form-control damage" id="resist">
                    <div class="form-group">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text small">ダメージ変化量</span>
                            </div>
                            <input type="text" class="form-control" readonly="" id="resistDamage">
                            <div class="input-group-append">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <small class="form-text text-muted  opacity kadomaru">対応する耐性値を入力して下さい。弱点はマイナスの値を入力をして下さい</small>
                </div>
                <div class="form-group damageCulc col-xs-12 col-md-6 col-lg-4">
                    <label for="vit" class="badge badge-pill badge-light">敵体力
                        <img src="https://www.silhouette-illust.com/wp-content/uploads/2016/05/646-300x300.jpg" width="16" height="16">
                    </label>
                    <input type="number" class="form-control damage" id="vit" placeholder="">
                </div>
                <div class="form-group vitCulc col-xs-12 col-md-6 col-lg-4" id="damageMemo">
                    <label for="damage1" class="badge badge-pill badge-light">
                        ダメージメモ
                        <img src="https://www.silhouette-illust.com/wp-content/uploads/2016/08/6654-300x300.jpg" width="16" height="16">
                    </label>
                    <input type="number" class="form-control damage" id="damage1" placeholder="ダメージ記録1">
                    <input type="number" class="form-control damage" id="damage2" placeholder="ダメージ記録2">
                    <input type="number" class="form-control damage" id="damage3" placeholder="ダメージ記録3">
                    <input type="number" class="form-control damage" id="damage4" placeholder="ダメージ記録4">
                    <input type="number" class="form-control damage" id="damage5" placeholder="ダメージ記録5">
                    <small class="form-text text-muted  opacity">発生したダメージを記録します<br>
                        ・背景が緑は重要だと思われる値です<br>
                        ・背景が黄は推定に必要なさそうな値です</small>
                </div>
            </div>
            <h1 class="vitCulc opacity text-center">推定体力計算</h1>
            <table class="vitCulc table table-hover table-bordered table-sm" id="guess">
                <thead>
                    <tr class="table-primary">
                        <th class="col-xs-1">体</th>
                        <th class="col-xs-1">D1</th>
                        <th class="col-xs-1">D2</th>
                        <th class="col-xs-1">D3</th>
                        <th class="col-xs-1">D4</th>
                        <th class="col-xs-1">D5</th>
                        <th class="col-xs-1">D6</th>
                        <th class="col-xs-1">D7</th>
                        <th class="col-xs-1">D8</th>
                        <th class="col-xs-1">D9</th>
                        <th class="col-xs-1">D10</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>


            <h1 class="damageCulc  opacity text-center">ダメージレンジ</h1>
            <table class="damageCulc table table-hover table-bordered table-sm" id="damageRangeTable">
                <thead>
                    <tr class="table-primary opacity small">
                        <th class="col-xs-1">AVG</th>
                        <th class="col-xs-1">D1</th>
                        <th class="col-xs-1">D2</th>
                        <th class="col-xs-1">D3</th>
                        <th class="col-xs-1">D4</th>
                        <th class="col-xs-1">D5</th>
                        <th class="col-xs-1">D6</th>
                        <th class="col-xs-1">D7</th>
                        <th class="col-xs-1">D8</th>
                        <th class="col-xs-1">D9</th>
                        <th class="col-xs-1">D10</th>
                    </tr>
                </thead>
                <tbody class=""></tbody>
            </table>
            <br>
            <div class="opacity">
                Powered by <a href="https://twitter.com/nao_romasaga_rs" target="_new">nao_romasaga_rs</a><br>
                Special thanks <a href="https://twitter.com/imonoki" target="_new">imonoki</a><br>
                © 2019 SQUARE ENIX CO., LTD. All Rights Reserved. Powered by Akatsuki Inc.<br>
                ILLUSTRATION: TOMOMI KOBAYASHI
            </div>

        </div> <!-- main -->
        <script type="text/javascript">
            $(function () {
                var wepon;
                var ability;
                var resist;
                var damage;
                var master;
                var wepK;
                var sv;
                var v;
                var agi;
                var type;
                $("#taijyutsu").hide();
                $(".vitCulc").hide();
                $('#damageTab').click(function () {
                    $(".damageCulc").show();
                    $(".vitCulc").hide();
                });
                $('#vitTab').click(function () {
                    $(".damageCulc").hide();
                    $(".vitCulc").show();
                });
                $('#skillTab').click(function () {
                    $(".damageCulc").hide();
                    $(".vitCulc").hide();
                    $("#damageMemo").show();
                });

                $('#resist').change(function () {
                    var r = $('#resist').val();
                    $("#resistDamage").val(Math.round(1 / (1 + 0.008 * r) * 100 * 100) / 100);
                });

                $('#type').change(function () {
                    type = $("#type").val();
                    if (type == 1) {
                        $("#param_label").text("腕力");
                        $("#taijyutsu").hide();
                    } else if (type == 2) {
                        $("#param_label").text("器用さ");
                        $("#taijyutsu").hide();
                    } else if (type == 3) {
                        $("#param_label").text("腕力");
                        $("#taijyutsu").show();
                    }
                });

                $('.damage').change(function () {
                    culc();
                });
                function damageColor(damage, max, min, target) {
                    if (damage > 0 && (damage == max || damage == min)) {
                        target.removeClass("bg-warning");
                        target.addClass("bg-success");
                        target.addClass("text-white");
                    } else if (damage > 0) {
                        target.addClass("bg-warning");
                        target.removeClass("bg-success");
                        target.removeClass("text-white");
                    } else {
                        target.removeClass("bg-warning");
                        target.removeClass("bg-success");
                        target.removeClass("text-white");
                    }
                }

                function culc() {
                    // グローバル変数へ代入
                    wepon = Number($("#wepon").val());
                    ability = Number($("#ability").val()) / 100;
                    resist = Number($("#resist").val());
                    damage1 = Number($("#damage1").val());
                    damage2 = Number($("#damage2").val());
                    damage3 = Number($("#damage3").val());
                    damage4 = Number($("#damage4").val());
                    damage5 = Number($("#damage5").val());
                    // 必要なダメージの設定
                    var max = Math.max(damage1, damage2, damage3, damage4, damage5);
                    var tmp1 = (damage1 > 0) ? damage1 : 99999;
                    var tmp2 = (damage2 > 0) ? damage2 : 99999;
                    var tmp3 = (damage3 > 0) ? damage3 : 99999;
                    var tmp4 = (damage4 > 0) ? damage4 : 99999;
                    var tmp5 = (damage5 > 0) ? damage5 : 99999;
                    var min = Math.min(tmp1, tmp2, tmp3, tmp4, tmp5);
                    console.log("======== max " + max + " / " + min);
                    damageColor(damage1, max, min, $("#damage1"));
                    damageColor(damage2, max, min, $("#damage2"));
                    damageColor(damage3, max, min, $("#damage3"));
                    damageColor(damage4, max, min, $("#damage4"));
                    damageColor(damage5, max, min, $("#damage5"));

                    damage = damage1;
                    master = masterLevel($("#master").val());
                    type = $("#type").val();

                    if (type == 3) { // 他のfunctionでも使うのでここで定義（やり方としては下の下）
                        wepK = ((wepon + 9) / 10.5);
                    } else {
                        wepK = ((wepon + 6) / 7);
                    }

                    sv = Number($("#str").val());
                    agi = Number($("#agi").val());
                    v = Number($("#vit").val());

                    var gVit = guessVitCulc();
                    var fieldSTR = getFieldSTR(v);
                    var baseDamage = baseDamageCulc(fieldSTR);

                    console.log("guessVit: " + gVit);
                    console.log("baseDamage: " + baseDamage);

                    dRange = damageRange(baseDamage);
                    dispDamageRange(dRange);

                    console.log("damageRange: " + dRange);
                    console.log("damage1 :" + damage1);
                    if (damage1 > 0) {
                        var vitCuld = vitCulc(Math.floor(gVit), damage1, damage2, damage3, damage4, damage5);
                        dispGuess(vitCuld);
                    }
                }

                function baseDamageCulc(fieldSTR) {
                    if (type == 3) {
                        // (D+6) / 7 * (1 + 4W -1.5T) * アビ * マスター * 耐性
                        // console.log("(D+6)/7 * (1 + 4W -1.5T) * アビ * マスター * 耐性");
                        // console.log(wepK  + " * (1 + " + 4*sv+ " - " + 1.5 * v+") * Mlv " + master + "  * アビリティ " + (1 + ability) + " * 耐性 " / (1 + 0.008 * resist));
                    } else {
                        // (D+9) / 7 * (1 + 4W -1.5T) * アビ * マスター * 耐性
                        // console.log("(D+6)/7 * (1 + 4W -1.5T) * アビ * マスター * 耐性");
                        // console.log(Math.floor(wepK*10)/10  + " * (1 + " + 4*sv+ " - " + 1.5 * v+") * Mlv " + master + "  * アビリティ " + (1 + ability) + " * 耐性 " / (1 + 0.008 * resist));
                    }
                    // console.log("Base : " + wepK * (fieldSTR) );
                    // console.log("Master : " + wepK * (fieldSTR)  * master );
                    // console.log("Ability : " + wepK * (fieldSTR) * master * (1 + ability) );
                    // console.log("Resist : " + wepK * (fieldSTR) * master * (1 + ability) / (1 + 0.008 * resist) );
                    return wepK * (fieldSTR) * master * (1 + ability) / (1 + 0.008 * resist);
                }

                function guessVitCulc() {
                    if (type == 3) {
                        console.log("guessVitCulc : 1 + 2 * " + sv + " + 2.5 * " + agi + " - (" + damage + "/ ( " + wepK + " * " + master + " * (1 + " + ability + ") / (1 + 0.008 * " + resist + ") ) ))/ 1.2");
                        return  (1 + (2 * sv + 2.5 * agi) - (damage / (wepK * master * (1 + ability) * (1 + 0.008 * resist)))) / 1.2;
                    } else {
                        console.log("guessVitCulc : 1 + 4 * " + sv + "- (" + damage + "/ ( " + wepK + " * " + master + " * (1 + " + ability + ") / (1 + 0.008 * " + resist + ") ) ))/ 1.5");
                        return  (1 + 4 * sv - (damage / (wepK * master * (1 + ability) / (1 + 0.008 * resist)))) / 1.5;
                    }
                }

                function damageRange(baseDamage) {
                    var damageRange = [];
                    var tanni = 1; // 小数点何位まで出す？(1,10,100)
                    for (var i = 0; i < 10; i++) {
                        damageRange.push(Math.round(baseDamage * (1 + 0.01 * i) * tanni) / tanni);
                    }
                    return damageRange;
                }

                function getFieldSTR(guess) {
                    if (type == 3) {
                        return ((2 * sv + 2.5 * agi) > 1.2 * guess) ? (1 + (2 * sv + 2.5 * agi) - 1.2 * guess) : 0;
                    } else {
                        return (4 * sv > 1.5 * guess) ? (1 + 4 * sv - 1.5 * guess) : 0;
                    }
                }

                function vitCulc(guess, damage1, damage2, damage3, damage4, damage5) {
                    var maxDamage = 99999;
                    var result = [];
                    memoryMaxDamage = Math.max(damage1, damage2, damage3);
                    var countdown = 20;
                    var limit = 100; // 無限ループ回避
                    while (countdown > 0 && limit > 0) {
                        // D10値が記録の最大を超えてもバッファで少し見てみる
                        if (memoryMaxDamage >= maxDamage) {
                            countdown--;
                        }
                        //console.log(guess);
                        fieldSTR = getFieldSTR(guess);
                        var base = baseDamageCulc(fieldSTR);
                        var range = damageRange(base);

                        console.log("guess:" + guess + " input:" + memoryMaxDamage + " max:" + maxDamage + " CD:" + countdown + " range:" + range);
                        var pushFlg1 = false;
                        var pushFlg2 = !(damage2 > 0);
                        var pushFlg3 = !(damage3 > 0);
                        var pushFlg4 = !(damage4 > 0);
                        var pushFlg5 = !(damage5 > 0);
                        maxDamage = range[9];
                        var gosa = 0;
                        if (maxDamage <= 200) {
                            gosa = 0;
                        } else if (maxDamage < 1000) {
                            gosa = 1;
                        } else {
                            gosa = 2;
                        }
                        range.forEach(function (d, i) {
                            if (d <= damage1 + gosa && d >= damage1 - gosa) {
                                range[i] = d + "R";
                                pushFlg1 = true;
                            }
                            if (d <= damage2 + gosa && d >= damage2 - gosa) {
                                range[i] = d + "R";
                                pushFlg2 = true;
                            }
                            if (d <= damage3 + gosa && d >= damage3 - gosa) {
                                range[i] = d + "R";
                                pushFlg3 = true;
                            }
                            if (d <= damage4 + gosa && d >= damage4 - gosa) {
                                range[i] = d + "R";
                                pushFlg4 = true;
                            }
                            if (d <= damage5 + gosa && d >= damage5 - gosa) {
                                range[i] = d + "R";
                                pushFlg5 = true;
                            }
                        });
                        if (pushFlg1 && pushFlg2 && pushFlg3 && pushFlg4 && pushFlg5) {
                            result.push(range);
                        }
                        range.unshift(guess);
                        guess++;
                        limit--;
                    }
                    return result;
                }

                function masterLevel(lv) {
                    var skill = Math.ceil((lv - 1) / 2) * 0.005 + 1;
                    var od = Math.ceil((lv - 2) / 2) * 0.005;
                    return skill;
                }

                function dispGuess(dRange) {
                    $("table#guess tbody *").remove();

                    for (i = 0; i < dRange.length; i++) {
                        var col = "";
                        for (j = 0; j < dRange[i].length; j++) {
                            if (String(dRange[i][j]).indexOf("R") !== -1) {
                                col += "<td class=\"small table-light\">" + dRange[i][j].replace(/R/g, "") + "</td>";
                            } else {
                                col += "<td class=\"small opacity col-xs-1\" >" + dRange[i][j] + "</td>";
                            }
                        }
                        $("table#guess tbody").append("<tr>" + col + "</tr>\n");
                    }
                }

                function dispDamageRange(dRange) {
                    $("table#damageRangeTable tbody *").remove();

                    var col = "";
                    var sum = 0;
                    for (i = 0; i < dRange.length; i++) {
                        col += "<td class=\"small opacity col-xs-1\" >" + dRange[i] + "</td>";
                        sum += dRange[i];
                    }
                    console.log(sum + " / " + dRange.length);
                    $("table#damageRangeTable tbody").append("<tr>" + "<td class=\"small opacity col-xs-1\" >" + Math.round(sum / dRange.length) + "</td>" + col + "</tr>\n");
                }
            });
        </script>
    </body>
</html>
