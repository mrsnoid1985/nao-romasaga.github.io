<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        <link rel="stylesheet" type="text/css" href="./css/style.css">
        <link href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c" rel="stylesheet">
        <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-database.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-auth.js"></script>
        <script src="./js/Firebase.js"></script>

        <script src="./js/utils.js" ></script>
        <title>特訓タイマー@nao_romasaga</title>
        <!-- http://ifs.nog.cc/hkaityo.hp.infoseek.co.jp/dq/rs2-01.html -->
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
        <style>
            .char-dojo {
                display: inline-block;
                width: 60px;
                height: 60px;
                background-position: -10px -10px;
                margin: 0 0 0 0px;
                animation: dojo 4s steps(1) infinite;
            }                      
            @keyframes dojo {
                0% { background-position: -10px -250px;  transform: scale(-1, 1);} /*4,5*/
                20% { background-position: -250px -170px;} /*4,5*/
                25% { background-position: -330px -170px;} /*4,5*/
                30% { background-position: -250px -170px;} /*4,5*/
                35% { background-position: -330px -170px;} /*4,5*/
                60% { background-position: -330px -250px;} /*4,5*/
                90% { background-position: -330px -90px; } /*4,5*/
            }
            .dojo-slide {
                transition-duration: 2s;
                margin-top: 0px;
                margin-left: 0px;
                animation: dojoslide 4s infinite;
            }
            @keyframes dojoslide {
                0% { transform:translateX(0%)}
                10% { transform:translateX(15%);}
                50% { transform:translateX(25%);}
                90% { transform:translateX(25%);}
                100% { transform:translateX(0%)}
            }

            .arrow_box {
                position: relative;
                background: #e6dcb4;
                border-radius: 6px;
            }
            .arrow_box:after, .arrow_box:before {
                bottom: 100%;
                left: 40px;
                border: solid transparent;
                content: " ";
                height: 0;
                width: 0;
                position: absolute;
                pointer-events: none;
            }

            .arrow_box:after {
                border-color: rgba(136, 183, 213, 0);
                border-bottom-color: #e6dcb4;
                border-width: 30px;
                margin-left: -30px;
            }
        </style>
    </head>
    <body>
        <div class="dojohaikei"><div class="container">
                <div class="text-center">
                    <a href="https://www.jp.square-enix.com/saga_reuniverse/" target="new"><img src="https://www.jp.square-enix.com/saga_reuniverse/assets/img/cmn_logo01_sp.png" class="col-sm-12 col-md-8 col-lg-6"></a>
                </div>

                <h1 class="text-center opacity">特訓タイマー</h1>
                <br>
                <div class="text-center">
                </div>
                <p class="text-right opacity"><small>バグ発見、ご要望は <a href="https://twitter.com/nao_romasaga_rs" target="new">nao_romasaga_rs</a>まで</small>
                </p>
                <div class="text-center">
                    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="true">Tweet</a>
                    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                </div>
                <div id="main">
                </div>
                <script>
                    $(document).ready(function () {
                        tableCopy(1);
                        tableCopy(2);
                        tableCopy(3);
                        tableCopy(4);
                        tableCopy(5);
                        addChar(1);
                        addChar(2);
                        addChar(3);
                        addChar(4);
                        addChar(5);

                        $(".char-hashiri").click(function () {
                            let id = $(this).parent().parent().attr("data-id");
                            let rare = $(this).attr("data-rare");
                            $("#badge" + id).attr("src", "https://nao-romasaga.github.io/img/icon/icon_" + rare + ".png");
                            $(".pieceImg" + id).attr("src", "https://nao-romasaga.github.io/img/icon/icon_piece_" + rare + ".png");
                            $("#rare" + id).val(rare);

                            $("#detail" + id).removeClass("d-none");
                            let char = $("<span>")
                                    .addClass("char-dojo dot dot_mid")
                                    .attr("style", $(this).attr("style"));
                            let div = $("<div>").addClass("dojo-slide").attr("id", "slidechar" + id).append(char);
                            $("#slidechar" + id).remove();
                            $("#slideTd" + id).append(div);
                            $(".charChoise" + id).slideToggle(200, function () {
                                $("#charChoise" + id).toggleClass("d-none");
                            });

                        });
                        $(".inputOpen").click(function () {
                            let id = $(this).attr("data-id");
                            $("#detail" + id).parent().toggleClass("d-none");
                            $("#detail" + id).slideToggle(300);
                        });
                        $(".inputClose").click(function () {
                            let id = $(this).attr("data-id");
                            $("#detail" + id).slideToggle(300, function () {
                                $("#detail" + id).parent().toggleClass("d-none");
                            });
                        });
                        $(".charToggle").click(function () {
                            let id = $(this).parent().attr("data-id");
                            $("#charChoise" + id).toggleClass("d-none");
                            $(".charChoise" + id).slideToggle(200);
                        });

                        $(".calc").change(function () {
                            let id = $(this).attr("data-id");
                            console.log($(this), id);
                            calc(id, $("#rare" + id).val());
                        });

                    });
                    function addChar(id) {
                        let tmpl = $("#charTemplate").clone();
                        tmpl.attr("data-id", id);
                        tmpl.removeClass("d-none");
                        tmpl.addClass("charChoise" + id);
                        tmpl.removeAttr("id");
                        $("#charChoise" + id).append(tmpl);
                    }

                    let NEED_PIECE = {
                        31: 5, 32: 5, 33: 5,
                        34: 10, 35: 10, 36: 10,
                        37: 15, 38: 15, 39: 15,
                        40: 20, 41: 20,
                        42: 40, 43: 40,
                        44: 50, 45: 50, 46: 50,
                        47: 60, 48: 60, 49: 60, 50: 60
                    };
                    let DAILY_MISSION = {"A": 3, "S": 0, "SS": 0};
                    let WEEKLY_MISSION = {"A": 104, "S": 43, "SS": 5};
                    let PIECE_HOUR = {"A": 1, "S": 2, "SS": 5};
                    let WHITE_HOUR = {"A": 10, "S": 15, "SS": 25};
                    let WHITE_RATE = {"A": 400, "S": 600, "SS": 1000};
                    function calc(no, rare) {
                        console.log(no, rare);
                        let pieceHour = PIECE_HOUR[rare];  // 1,2,5
                        let whiteHour = WHITE_HOUR[rare]; // 10,15,25
                        let rate = WHITE_RATE[rare]; // 400,600,1000
                        let missionBonus = WEEKLY_MISSION[rare];
                        let dmissionBonus = DAILY_MISSION[rare];
                        let taskRate = pieceHour / whiteHour;

                        let nowLv = Number($("#nowLv" + no).val());
                        let targetLv = Number($("#nextLv" + no).val());
                        let mission = $("#missionUse" + no).prop('checked');
                        console.log(mission);

                        let total = 0;
                        for (let lv in NEED_PIECE) {
                            lv = Number(lv);
                            let piece = Number(NEED_PIECE[lv]);
                            if (lv > nowLv) {
                                total += piece;
                            }
                            //console.log(nowLv, targetLv, lv, piece, total);
                            if (lv === targetLv) {
                                break;
                            }
                        }
                        let nowPiece = $("#nowPiece" + no).val();
                        total -= nowPiece;
                        // デイリーウィークリーのミッションピースを使う場合
                        let missionRate = 0;
                        if (mission) {
                            // ウィークリーで増えるレート
                            missionRate = pieceHour / (24 * 7 / missionBonus);
                            missionRate += pieceHour / (24 / dmissionBonus);
                        }
                        console.log("missionRate", missionRate, pieceHour, missionBonus);

                        let other = Number($("#otherStyle" + no).val());
                        console.log("other", other);
                        let needHour = Math.floor(total * pieceHour / (1 + (other * taskRate) + missionRate));
                        console.log("needHour", needHour, "Hour:", total * pieceHour, (1 + (other * taskRate) + missionRate));
                        let gold = Math.floor(needHour / pieceHour);
                        let white = Math.floor(needHour / whiteHour * other);
                        let week = Math.floor(needHour / (24 * 7));
                        let day = Math.floor((needHour - (week * 24 * 7)) / 24);
                        let missionP = (mission) ? week * missionBonus + day * dmissionBonus : 0;
                        console.log("total", total, "gold", gold, "white", white, "mission", missionP);

                        let i = 0;
                        while ((gold + white + missionP) < total) {
                            needHour = needHour + pieceHour;
                            gold = Math.floor(needHour / pieceHour);
                            white = Math.floor(needHour / whiteHour * other);
                            week = Math.floor(needHour / (24 * 7));
                            day = Math.floor((needHour - (week * 24 * 7)) / 24);
                            lest = needHour - week * 24 * 7 - day * 24;
                            missionP = (mission) ? week * missionBonus + day * dmissionBonus : 0;
                            console.log(i, pieceHour, "needHour", needHour, "week", week, lest, "day", day, "gold", gold, "white", white, "mission", missionP);
                        }
                        needHour = Math.round(needHour);
                        console.log(needHour, total, gold, white, missionP);
                        // totalは単純にかかった時間
                        // 5分で1.2 = 120
                        // 83 = 415 + 16

                        $("#missonp" + no).text(missionP);
                        $("#kunrenp" + no).text(gold);
                        $("#whitep" + no).text(white);
                        $(".totalp" + no).text(total);
                        $("#totalh" + no).text(needHour.toLocaleString());

                        var date = new Date();
                        console.log(getDateString(date));
                        date.setHours(date.getHours() + needHour);
                        $("#tassei" + no).text(getDateString(date));
                    }
                    function getDateString(date) {
                        var month = date.getMonth() + 1;
                        var day = date.getDate();
                        var hour = ("0" + date.getHours()).slice(-2);
                        var minute = ("0" + date.getMinutes()).slice(-2);
                        return month + "/" + day + " " + hour + ":" + minute;
                    }
                    function tableCopy(id) {
                        let table = $("#template").clone();
                        table.removeAttr("id").removeClass("d-none");
                        table.find(".disp").attr("data-id", id);

                        table.find("#slideTd1").attr("id", "slideTd" + id);
                        table.find("#rare1").attr("id", "rare" + id);
                        table.find("#badge1").attr("id", "badge" + id);
                        table.find("#slidechar1").attr("id", "slidechar" + id);
                        table.find("#tassei1").attr("id", "tassei" + id);
                        table.find("#totalh1").attr("id", "totalh" + id);
                        table.find(".inputOpen").attr("data-id", id);
                        table.find(".inputClose").attr("data-id", id);
                        table.find(".detail1").removeClass("detail1").addClass("detail" + id).attr('id', "detail" + id);

                        table.find(".totalp1").each(function () {
                            $(this).removeClass("totalp1").addClass("totalp" + id);
                        });
                        table.find(".pieceImg1").each(function () {
                            $(this).removeClass("pieceImg1").addClass("pieceImg" + id);
                        });
                        table.find(".charChoise1").each(function () {
                            $(this).removeClass("charChoise1").addClass("charChoise" + id).attr("data-id", 2);
                        });
                        table.find("#charChoise1").attr("id", "charChoise" + id);
                        table.find("#kunrenp1").attr("id", "kunrenp" + id).attr("data-id", id);
                        table.find("#whitep1").attr("id", "whitep" + id).attr("data-id", id);
                        table.find("#missonp1").attr("id", "missonp" + id).attr("data-id", id);
                        table.find("#nowLv1").attr("id", "nowLv" + id).attr("data-id", id);
                        table.find("#nextLv1").attr("id", "nextLv" + id).attr("data-id", id);
                        table.find("#nowPiece1").attr("id", "nowPiece" + id).attr("data-id", id);
                        table.find("#otherStyle1").attr("id", "otherStyle" + id).attr("data-id", id);
                        table.find("#missionUse1").attr("id", "missionUse" + id).attr("data-id", id);
                        table.find("#forCb").removeAttr("for").attr("for", "missionUse" + id);
                        $("#main").append(table);
                    }


                </script>

            </div></div>
        <table class="width-100 d-none" id="template">
            <tr class="disp" data-id="1">
                <td style="width:120px" class="charToggle" id="slideTd1">
                    <img id="badge1" style="position:absolute; margin: -10px" src="http://www.graviness.com/virgo/javascript/diaryfiles/empty.gif" width="30" height="30">
                    <input type="hidden" id="rare1">
                    <span class="kakashi"></span>
                    <div class="dojo-slide" id="slidechar1">
                        <span class="char-dojo dot dot_mid"></span>
                    </div>
                </td>
                <td class="style-skill-window" style="padding-left:5%">
                    <input type="text" class="input" placeholder="キャラクター名をメモ" style="font-size:8px; width:80%"><br>
                    <div class="inputOpen width-100 mar0">
                        <p style="margin-bottom: -10px">
                            達成日時：<span id="tassei1"></span></p>
                        <p style="margin-bottom: 10px">
                        <img src="https://nao-romasaga.github.io/img/icon/icon_timer.png" width=25 height=25><span id="totalh1"></span>時間
                        <img class="pieceImg1" src="https://nao-romasaga.github.io/img/icon/icon_piece_SS.png" width=40 height=40><span class="totalp1"></span>個
                        </p>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="3" class="arrow_box" style="padding: 5px 0px 0px 5px;" data-id="1" id="charChoise1">
                </td>
            </tr>
            <tr>
                <td colspan="3" class="opacity-char-back" style="padding: 5px 0px 0px 5px; ">
                    <div class="detail1 d-none" id="detail1">
                        <div class="char-bottom">
                            <span class="float-right inputClose" style="margin: 10px 10px 0 0; text-align: center; background:url(https://nao-romasaga.github.io/img/icon/icon_button_on.png); width:128px; height:40px; padding-top:6px">閉じる</span>
                            <img class="pieceImg1" width=40 height=40><span class="totalp1"></span>個内訳<br>
                            ・特訓での獲得:<span id="kunrenp1"></span>個<br>
                            ・白結晶変換での獲得:<span id="whitep1"></span>個<br>
                            ・ミッションでの獲得:<span id="missonp1"></span>個
                        </div>
                        <div>
                            現在Lv　<input id="nowLv1" type="number" class="input kadomaru calc" style="width:30px" min="31" max="50" value="30">　 
                            目標Lv　<input id="nextLv1" type="number" class="input kadomaru calc" style="width:30px" min="31" max="50" value="50"><br>
                            現在の所持ピース数　<input id="nowPiece1" type="number" class="input kadomaru calc" style="width:50px" min="0" max="599" value="0">個
                            <br>
                            他スタイル<select id="otherStyle1" class="input kadomaru calc" style="width:50px" >
                                <option>0</option>
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                            </select>
                            体を特訓して白結晶にする
                            <div class="cb kadomaru">
                                <input type="checkbox" id="missionUse1" name="cb" value="1" class="calc">
                                <label id="forCb" for="missionUse1" style="font-size:initial;">ミッションで取得する<img class="pieceImg1"  width=40 height=40>を使う</label>
                            </div>                            
                        </div>                            
                    </div>
                </td>
            </tr>
        </table>

        <div class="d-none" id="charTemplate" style="background-color: #e6dcb4; border-radius: 8px;">
            <div class="char-bottom">
                <img style="vertical-align: top;" src="https://nao-romasaga.github.io/img/icon/icon_SS.png" width="40" height="40">
                <span class="char-hashiri dot dot_mid" data-rare="SS" style="background:url(https://nao-romasaga.github.io/img/dot/ID4bc81.png);" onclick=""></span>
                <span class="char-hashiri dot dot_mid" data-rare="SS" style="background:url(https://nao-romasaga.github.io/img/dot/ID4c7d6.png);" onclick=""></span>
                <span class="char-hashiri dot dot_mid" data-rare="SS" style="background:url(https://nao-romasaga.github.io/img/dot/ID35c2a.png);" onclick=""></span>
                <span class="char-hashiri dot dot_mid" data-rare="SS" style="background:url(https://nao-romasaga.github.io/img/dot/ID35c8c.png);" onclick=""></span>
                <span class="char-hashiri dot dot_mid" data-rare="SS" style="background:url(https://nao-romasaga.github.io/img/dot/ID36c9b.png);" onclick=""></span>
            </div>
            <div class="char-bottom">
                <img style="    vertical-align: top;" src="https://nao-romasaga.github.io/img/icon/icon_S.png" width="40" height="40">
                <span class="char-hashiri dot dot_mid" data-rare="S" style="background:url(https://nao-romasaga.github.io/img/dot/ID365ec.png);" onclick=""></span>
                <span class="char-hashiri dot dot_mid" data-rare="S" style="background:url(https://nao-romasaga.github.io/img/dot/ID36524.png);" onclick=""></span>
                <span class="char-hashiri dot dot_mid" data-rare="S" style="background:url(https://nao-romasaga.github.io/img/dot/ID641f4.png);" onclick=""></span>
                <span class="char-hashiri dot dot_mid" data-rare="S" style="background:url(https://nao-romasaga.github.io/img/dot/ID4e840.png);" onclick=""></span>
                <span class="char-hashiri dot dot_mid" data-rare="S" style="background:url(https://nao-romasaga.github.io/img/dot/ID35db8.png);" onclick=""></span>

            </div>
            <div class="char-bottom">
                <img style="    vertical-align: top;" src="https://nao-romasaga.github.io/img/icon/icon_A.png" width="40" height="40">
                <span class="char-hashiri dot dot_mid" data-rare="A" style="background:url(https://nao-romasaga.github.io/img/dot/ID3677c.png);" onclick=""></span>
                <span class="char-hashiri dot dot_mid" data-rare="A" style="background:url(https://nao-romasaga.github.io/img/dot/ID361a0.png);" onclick=""></span>
                <span class="char-hashiri dot dot_mid" data-rare="A" style="background:url(https://nao-romasaga.github.io/img/dot/ID4c450.png);" onclick=""></span>
                <span class="char-hashiri dot dot_mid" data-rare="A" style="background:url(https://nao-romasaga.github.io/img/dot/IDad764.png);" onclick=""></span>
                <span class="char-hashiri dot dot_mid" data-rare="A" style="background:url(https://nao-romasaga.github.io/img/dot/ID36718.png);" onclick=""></span>
            </div>            
        </div>
    </body>
</html>
